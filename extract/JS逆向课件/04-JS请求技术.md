# 4 JavaScript 请求技术

## 4.1 XMLHttpRequest

---

[WebAPI: XMLHttpRequest](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest)

`XMLHttpRequest`（XHR）对象用于与服务器交互。通过 XMLHttpRequest 可以在不刷新页面的情况下请求特定 URL，获取数据。这允许网页在不影响用户操作的情况下，更新页面的局部内容。`XMLHttpRequest` 在 [AJAX](https://developer.mozilla.org/zh-CN/docs/Glossary/AJAX) 编程中被大量使用。

[`XMLHttpRequest.open()`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/open)

方法初始化一个新创建的请求，或重新初始化一个请求。

```javascript
xhrReq.open(method, url, async);
```

[`XMLHttpRequest.send()`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/send)

发送请求。如果请求是异步的（默认），那么该方法将在请求发送后立即返回。

方法接受一个可选的参数，其作为请求主体；如果请求方法是 GET 或者 HEAD,则应将请求主体设置为 null。

```javascript
xhrReq.send(body);
```

[`XMLHttpRequest.setRequestHeader()`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/setRequestHeader)

设置 HTTP 请求头的值。必须在 `open()` 之后、`send()` 之前调用 `setRequestHeader()` 方法。

```javascript
myReq.setRequestHeader(header, value);
```

[`XMLHttpRequest.onreadystatechange`](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/readystatechange_event)

当 `readyState` 属性发生变化时，调用的事件处理器。

测试地址：[巨潮资讯](http://www.cninfo.com.cn/new/commonUrl?url=disclosure/list/notice#szseGem)

```javascript
// 请求参数
body =
  "column=szse_gem_latest&pageNum=2&pageSize=30&sortName=&sortType=&clusterFlag=true";

// 构造请求
let e = {
  url: "http://www.cninfo.com.cn/new/disclosure",
  method: "POST",
  data: body,
};
var h = new XMLHttpRequest();
// 初始化链接
h.open(e.method, e.url, true);
// 设置头部
h.setRequestHeader("accept", "application/json;charset=UTF-8");
// 接收响应
h.onreadystatechange = function () {
  if (h.status === 200) {
    console.log(JSON.parse(h.response));
  }
};
// 发请求
h.send(e.data);
```

## 4.2 axios

`*Axios*` 是一个基于`promise` 的网络请求库,可以用于浏览器和 `node.js Axios` 使用简单

官方地址：[axios-js 文档](http://www.axios-js.com/)

### 4.2.1 get 请求

```javascript
params = {
  id: 1,
  page: 2,
};
headers = {
  "user-agent": "12321321",
};
axios
  .get("https://wzzdg.sun0769.com/political/index/politicsNewest", {
    // 配置项
    params: params,
    headers: headers,
  })
  .then(function (response) {
    // 接收回数据调
  })
  .catch(function (error) {
    // 异常输出
  });
```

### 4.2.2 post 请求

```javascript
data = {
  key: "value",
};
headers = {
  key: "value",
};
axios
  .post("you url", data, {
    headers: headers,
  })
  .then(function (response) {
    // 接收回数据调
  })
  .catch(function (error) {
    // 异常输出
  });
```

### 4.2.3 Interceptors

- 请求拦截器：在发送请求之前，可以借助一些函数来对请求的内容和参数做一些检测。若有问题可以直接取消请求。
- 响应拦截器：当服务器返回响应数据时，响应拦截器会在我们拿到结果前预先处理响应数据。例如对响应数据做一些格式化处理，或者当响应失败时，可以做一些失败提醒和纪录。

```javascript
// npm install axios
axios = require("axios");
//设置请求拦截器
axios.interceptors.request.use(
  function (config) {
    console.log("请求拦截器 成功");
    config.headers["sign"] = "lili";
    return config;
  },
  function (error) {
    console.log("请求拦截器 失败");
    return Promise.reject(error);
  }
);

//设置响应拦截器
axios.interceptors.response.use(
  function (response) {
    console.log("响应拦截器 成功");
    console.log("调解密函数进行解密数据");
    //return response;
    return response.data; //修改响应数据
  },
  function (error) {
    console.log("响应拦截器 失败");
    return Promise.reject(error);
  }
);

//发送请求
axios.get("http://httpbin.org/get").then((res) => console.log(res));
```

## 4.3 异步请求

[node](https://so.csdn.net/so/search?q=node&spm=1001.2101.3001.7020) 中没有实现 fetch，你可以使用 [node-fetch](https://github.com/bitinn/node-fetch)，使得在 node 中也可以使用 fetch

### 4.3.1 get 请求

```javascript
const url = "https://wzzdg.sun0769.com/political/index/politicsNewest";
async function get_test(url) {
  const headers = {
    "User-Agent": "12321312",
  };
  const params = {
    id: 1,
    page: 2,
  };
  const res = await fetch(url, {
    method: "GET",
    params: params,
    headers,
    credentials: "include",
  });
  const data = await res.text();
  console.log(data);
}
// get_test(url)
```

### 4.3.2 post 请求

测试地址：[中国土地市场网](https://www.landchina.com/#/plotPromotion)

```javascript
async function postJSON(data) {
  try {
    const response = await fetch("https://api.landchina.com/landRecommend/recommend/list", {
      method: "POST", // or 'PUT'
      headers: {
        "Content-Type": "application/json",
        "referer": "https://www.landchina.com/",
      },
      body: JSON.stringify(data),
    });
    const result = await response.json();
    console.log("Success:", result);
  } catch (error) {
    console.error("Error:", error);
  }
}
const data = {"key","value"}
```
