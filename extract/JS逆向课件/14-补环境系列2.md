# 14 补环境系列教程

[在线文档](https://note.youdao.com/s/KPLGlYIq)

[在线文档 dc0e](https://www.yuque.com/buziran/nktf0k/gp19ir8ibukgmi0f?singleDoc#)

## 14.1 环境简介

![image-20240611205100346](./images/image-20240611205100346.png)

![image-20240611205115016](C:\Users\XL\AppData\Roaming\Typora\typora-user-images\image-20240611205115016.png)

## 14.2 项目实操

### 14.2.1 逆向目标

地址：http://q.10jqka.com.cn/

### 14.2.2 补环境实操

先补充基本的环境

![image-20221201221307777](images\image-20221201221307777.png)

注：如图环境补完后、发现还是没有 cookie 的值、这个时候需要排查是不是代码走了其他的分支、导致输出异常。可以在`try、catch`里面输出查看。

![image-20221201221150407](images\image-20221201221150407.png)

在这个位置输出、可以发现有环境出现了异常，这个时候需要补了

![image-20221201221646291](images\image-20221201221646291.png)

## 14.3 吐环境脚本

### 14.3.1 简介

地址：https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy

`Proxy`可以理解为，在目标对象之前设一层"拦截"，外界对该对象的访问，都必须通过这层拦截,可以对外界的访问进行过滤和改写（表示可以用它"代理"某些操作，可以翻为“代理器"）。

![img](https://upload-images.jianshu.io/upload_images/6662793-b2337b464c5bcb7f.jpg?imageMogr2/auto-orient/strip|imageView2/2/w/1200/format/webp)

Proxy 对象由两个部分组成：target、handler

target:目标对象
handler：是一个对象，声明了代理 target 的指定行为，支持的拦截操作，一共 13 种：

- get(target,propKey,receiver)：拦截对象属性的读取。
- set(target,propKey,value,receiver)：拦截对象属性的设置，返回一个布尔值（修改成功）。

对于 JS 逆向来说，我们扣完代码的目的就是调用目标网站的加/解密函数或某个值的算法，一般情况下我们把他的算法扣下来能够直接执行，但是如果检测了浏览器指纹，那就比较难了，只能够去深入分析进行补环境。

一般的补环境的是通过运行程序后的 undefined 报错去一点一点分析，一点一点的去补一些环境，是非常掉头发的。

所以我们使用 Proxy 对全局遍历 window、document、navigator 等常见环境检测点进行代理，拦截代理对象的读取、函数调用等操作，并通过控制台输出，这样的话我们就能够实现检测环境自吐的功能，后续我们再针对吐出来的环境统一的进行补环境，这样就会方便的多。

### 14.3.2 基本原理

```javascript
var target = {
  name: "JACK",
  age: 18,
};

let p = new Proxy(target, {
  get: function (a, b, c) {
    /*
     * 1 原对象
     * 2 访问属性
     * 3 代理器处理对象
     * */
    console.log(a, b, c);
  },
});
```

**数据返回**

`Reflect.set(target, name, value, receiver)` 是 JavaScript 中的 Reflect 对象的一个方法。它用于设置指定对象的属性值，并返回一个布尔值，表示设置是否成功。

参数的含义如下：

- `target`：要设置属性值的目标对象。
- `name`：要设置的属性名。
- `value`：要设置的属性值。
- `receiver`（可选）：设置属性时绑定的 `this` 值。

```javascript
Reflect.get(target, name, receiver); //查找并返回target对象的name属性，receiver绑定this
Reflect.set(target, name, value, receiver); //设置target对象的name属性等于value
```

**代理使用方法**

```javascript
xx = new Proxy(target, {
  get: function (target, property, receiver) {
    temp = Reflect.get(target, property, receiver);
    // console.log("get: ", target, property, target[property]);
    console.log(`对象${target}--> get了属性--> ${property} 值是--> ${temp}`);
    return temp;
  },
  set(target, p, value, receiver) {
    console.log("set: ", target, p, target[p]);
    temp = Reflect.set(target, p, value, receiver); //设置target对象的name属性等于value
    return temp;
  },
});
```

**代理封装**

```javascript
// 目标对象（被代理对象）
var target = {
  name: "JACK",
  age: 18,
  lili: {
    zs: "nana",
  },
};

function XlProxy(obj, name) {
  return new Proxy(obj, {
    get(target, p, receiver) {
      temp = Reflect.get(target, p, receiver);
      console.log(`对象${name}--> get了属性--> ${p} 值是--> ${temp}`);
      if (typeof temp == "object") {
        // 对于对象套对象进行挂代理
        temp = XlProxy(temp, name + "-->" + p);
      }
      return temp;
    },
  });
}
sss = XlProxy(target, "target");
sss.name;
```

### 14.3.2 脚本编写

针对浏览器 api 进行属性 hook 操作

```javascript
navigator = new Proxy(navigator, {
  set(target, property, value, receiver) {
    console.log(`设置属性set ${target}`, property, typeof value);
    return Reflect.set(...arguments);
  },
  get(target, property, receiver) {
    console.log(`获取属性get  ${target}`, property, typeof target[property]);
    return target[property];
  },
});
```

## 14.4 操作 selenium 加载

3.1 这里需要学习 web 开发框架结合自动化 selenium 技术，需要理解前后端开发技术

3.2 有时间可以复习下 flask 框架开发技术

```
pip install flask
```

Flask 是一个基于 Python 的轻量级、简单易用的 Web 应用框架。它提供了一个灵活且容易扩展的方式来构建 Web 应用程序。以下是一个简单的示例展示了如何使用 Flask 框架创建一个简易的 Web 应用：

```python
from flask import Flask

# 创建 Flask 应用实例
app = Flask(__name__)

# 定义路由和视图函数
@app.route('/')
def hello():
    return 'Hello, Flask!'

# 启动应用
if __name__ == '__main__':
    app.run()
```

在上述示例中，我们首先导入了 Flask 模块，并创建了一个 Flask 应用实例 `app`。然后，使用 `@app.route()` 装饰器定义了一个路由以及对应的视图函数。在本例中，根路由 `'/'` 对应的视图函数是 `hello()`，它返回了一个简单的字符串 `'Hello, Flask!'`。最后，通过调用 `app.run()` 来启动应用。

要运行这个应用，你需要确保已经安装了 Flask 模块。运行应用后，在浏览器中访问 `http://localhost:5000/`，你将看到输出的 `'Hello, Flask!'`。

这只是一个非常简单的示例，Flask 提供了更多功能和强大的扩展，例如请求处理、模板渲染、表单处理、数据库集成等。你可以根据具体需求来扩展和定制你的 Flask 应用。了解 Flask 的官方文档将有助于你深入学习和理解框架的更多功能和用法。

## 14.5 `jsdom`补环境

参考地址：https://github.com/jsdom/jsdom/wiki/jsdom-中文文档

`jsdom`是一个纯粹由 `javascript` 实现的一系列 web 标准，特别是 WHATWG 组织制定的[DOM](https://dom.spec.whatwg.org/)和 [HTML](https://html.spec.whatwg.org/multipage/) 标准，用于在`nodejs`中使用。大体上来说，该项目的目标是模拟足够的 Web 浏览器子集，以便用于测试和挖掘真实世界的 Web 应用程序

### 14.5.1 环境安装

```
npm install jsdom --save
```

### 14.5.2 基本使用

```javascript
const jsdom = require("jsdom");
const { JSDOM } = jsdom;
const dom = new JSDOM(`<!DOCTYPE html><p>Hello world</p>`);
title = dom.window.document.querySelector("p").textContent;
console.log(title);
```

### 14.5.3 添加参数形式

```javascript
const dom = new JSDOM(``, {
  url: "http://q.10jqka.com.cn/",
  referrer: "http://q.10jqka.com.cn/",
  contentType: "text/html",
  includeNodeLocations: true,
  storageQuota: 10000000,
});
```
