# 爬虫常用代码和工具

## Debug

无限 Debugger 屏蔽

## Hook

### 控制台 Hook

#### Hook Debugger

```javascript {.line-numbers}
Function.prototype.constructor_ = Function.prototype.constructor;
Function.prototype.constructor = function (x) {
  if (x == "debugger") {
    return function () {};
  }
  return Function.prototype.constructor_(x);
};
```

#### Hook JSON 序列化和反序列化

```javascript {.line-numbers}
(function () {
  var _stringify = JSON.stringify;
  JSON.stringify = function (ps) {
    console.trace("Hook JSON.stringify ——> ", ps);
    return _stringify(ps); // 不改变原有的执行逻辑
  };
})();

(function () {
  var _parse = JSON.parse;
  JSON.parse = function (ps) {
    console.trace("Hook JSON.parse trace", ps); // 打印函数堆栈信息
    return _parse(ps); // 不改变原有的执行逻辑
  };
})();
```

#### Hook XHR 请求

```javascript {.line-numbers}
(function () {
  var open = window.XMLHttpRequest.prototype.open;
  window.XMLHttpRequest.prototype.open = function (method, url, async) {
    if (url.indexOf("analysis") != -1) {
      debugger;
    }
    return open.apply(this, arguments);
  };
})();
```

### 油猴 Hook

#### Hook XHR

```JavaScript {.line-numbers}
var need_get_arg = 'pageNum'; // 这里修改
var isdebugger = true;  // 决定断点
let _log = console.log

!(function (){
    var _originalXHR = window.XMLHttpRequest;
    window.XMLHttpRequest = function () {
        var xhr = new _originalXHR();
        var _open = xhr.open;
        xhr.open = function (method, url) {
            _log('XHR request:', url);
            if (method == "GET") {
                var splitUrl = url.split('?');
                if (splitUrl.length > 1) {
                    var params = splitUrl[1].split('&');
                    params.forEach(function (param) {
                        var keyValue = param.split('=');
                        if (keyValue[0] == need_get_arg) {
                            _log('参数', need_get_arg, '找到，值为：', decodeURIComponent(keyValue[1]));
                            if (isdebugger) {
                                debugger;
                            }
                        }
                    });
                }
            }

            if (method == "POST") {
                var _send = xhr.send;
                xhr.send = function (data) {
                    if (data) {
                        if (data.includes(need_get_arg)) {
                            _log("data-->", data)
                            if (isdebugger) {
                                debugger;
                            }
                        }
                    }
                    _send.call(this, data);
                };
            }
            _open.call(this, method, url);
        };
        return xhr;
    };
}())
```

#### Hook Timer

```javascript {.line-numbers}
setInterval = function () {};
```

## Http 请求

### Axios

> [axios-js 文档](http://www.axios-js.com/)

#### Axios 环境准备

```cmd {.line-numbers}
npm install axios -S
```

#### Axios get

```javascript {.line-numbers}
axios = require("axios");

url = "https://wzzdg.sun0769.com/political/index/politicsNewest";
params = {
  id: 1,
  page: 2,
};
headers = {
  "user-agent": "12321321",
};
axios
  .get(url, {
    // 配置项
    params: params,
    headers: headers,
  })
  .then(function (response) {
    // 接收回数据调
  })
  .catch(function (error) {
    // 异常输出
  });
```

#### Axios post

```javascript {.line-numbers}
axios = require("axios");

url = "you url";
data = {
  key: "value",
};
headers = {
  key: "value",
};
axios
  .post(url, data, {
    headers: headers,
  })
  .then(function (response) {
    // 接收回数据调
  })
  .catch(function (error) {
    // 异常输出
  });
```

### Fetch 请求

#### Fetch 环境准备

```cmd {.line-numbers}
npm install node-fetch -S
```

#### Fetch Get

```javascript
const url = "https://wzzdg.sun0769.com/political/index/politicsNewest";
async function get_test(url) {
  const headers = {
    "User-Agent": "12321312",
  };
  const params = {
    id: 1,
    page: 2,
  };
  const res = await fetch(url, {
    method: "GET",
    params: params,
    headers,
    credentials: "include",
  });
  const data = await res.text();
  console.log(data);
}
get_test(url);
```

#### Fetch Post

```javascript
async function postJSON(data) {
  try {
    // 中国土地市场网
    const response = await fetch("https://api.landchina.com/landRecommend/recommend/list", {
      method: "POST", // or 'PUT'
      headers: {
        "Content-Type": "application/json",
        "referer": "https://www.landchina.com/",
      },
      body: JSON.stringify(data),
    });
    const result = await response.json();
    console.log("Success:", result);
  } catch (error) {
    console.error("Error:", error);
  }
}
const data = {"key","value"}
```

### XHR 请求

```javascript
// 请求参数
body =
  "column=szse_gem_latest&pageNum=2&pageSize=30&sortName=&sortType=&clusterFlag=true";

// 构造请求
let e = {
  // 巨潮资讯
  url: "http://www.cninfo.com.cn/new/disclosure",
  method: "POST",
  data: body,
};
var h = new XMLHttpRequest();
// 初始化链接
h.open(e.method, e.url, true);
// 设置头部
h.setRequestHeader("accept", "application/json;charset=UTF-8");
// 接收响应
h.onreadystatechange = function () {
  if (h.status === 200) {
    console.log(JSON.parse(h.response));
  }
};
// 发请求
h.send(e.data);
```

## 加密

### 加密算法环境准备

```cmd {.line-numbers}
npm install crypto-jS -S
```

### 摘要算法

#### MD5

#### SHA

#### HMAC

### 对称算法

#### DES

```JavaScript
// 引用 crypto-js 加密模块
var CryptoJS = require('crypto-js')

function desEncrypt() {
    var key = CryptoJS.enc.Utf8.parse(desKey),
        iv = CryptoJS.enc.Utf8.parse(desIv),
        srcs = CryptoJS.enc.Utf8.parse(text),
        // CBC 加密模式，Pkcs7 填充方式
        encrypted = CryptoJS.DES.encrypt(srcs, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });
    return encrypted.toString();
}

function desDecrypt() {
    var key = CryptoJS.enc.Utf8.parse(desKey),
        iv = CryptoJS.enc.Utf8.parse(desIv),
        srcs = encryptedData,
        // CBC 加密模式，Pkcs7 填充方式
        decrypted = CryptoJS.DES.decrypt(srcs, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
        });
    return decrypted.toString(CryptoJS.enc.Utf8);
}

var text = "I love Python!"       // 待加密对象
var desKey = "6f726c64f2c2057"    // 密钥
var desIv = "0123456789ABCDEF"    // 初始向量

var encryptedData = desEncrypt()
var decryptedData = desDecrypt()

console.log("加密字符串: ", encryptedData)
    console.log("解密字符串: ", decryptedData)

// 加密字符串:  +ndbEkWNw2QAfIYQtwC14w==
// 解密字符串:  I love Python!
```

#### AES

### 非对称算法

#### RSA
