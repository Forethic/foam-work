# 0001-js_hook技术-XHR

## 标签

## 内容

定义了一个变量 `open` 保留原始 `XMLHttpRequest.open` 方法，然后重写 `XMLHttpRequest.open` 方法，判断如果 rnd 字符串值在 URL 里首次出现的位置不为 -1，即 URL 里包含 `analysis`字符串，则执行 `debugger` 语句，会立即断下。

```javascript {.line-numbers}
(function () {
    var open = window.XMLHttpRequest.prototype.open;
    window.XMLHttpRequest.prototype.open = function (method, url, async) {
        if (url.indexOf("analysis") != -1) {
            debugger;
        }
        return open.apply(this, arguments);
    };
})();
```

### 升级版

```JavaScript {.line-numbers}
var need_get_arg = 'pageNum';
var isdebugger = true;  // 决定断点
let _log = console.log

!(function (){
    var _originalXHR = window.XMLHttpRequest;
    window.XMLHttpRequest = function () {
        var xhr = new _originalXHR();
        var _open = xhr.open;
        xhr.open = function (method, url) {
            _log('XHR request:', url);
            if (method == "GET") {
                var splitUrl = url.split('?');
                if (splitUrl.length > 1) {
                    var params = splitUrl[1].split('&');
                    params.forEach(function (param) {
                        var keyValue = param.split('=');
                        if (keyValue[0] == need_get_arg) {
                            _log('参数', need_get_arg, '找到，值为：', decodeURIComponent(keyValue[1]));
                            if (isdebugger) {
                                debugger;
                            }
                        }
                    });
                }
            }

            if (method == "POST") {
                var _send = xhr.send;
                xhr.send = function (data) {
                    if (data) {
                        if (data.includes(need_get_arg)) {
                            _log("data-->", data)
                            if (isdebugger) {
                                debugger;
                            }
                        }
                    }
                    _send.call(this, data);
                };
            }
            _open.call(this, method, url);
        };
        return xhr;
    };
}())
```

## 参考
